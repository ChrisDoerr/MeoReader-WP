MeoReader.Import={total:{},targetCounter:1,active:false,buggyFeeds:[]};MeoReader.Import.timer={timeout:MeoReader.Import.timeout*1000,base:null,start:function(){MeoReader.Import.timer.base=new Date().valueOf();},stop:function(){MeoReader.Import.timer.base=null;},now:function(){return new Date().valueOf();}};MeoReader.Import.stopCheckingTarget=function(){clearInterval(MeoReader.Import.timerID);MeoReader.Import.timerRunning=false;};MeoReader.Import.checkTarget=function(){var content=MeoReader.Import.target.contents().find("body").html(),json=jQuery.parseJSON(content);if(null!==json&&undefined!==json.request){if(MeoReader.Import.targetCounter===2){MeoReader.Import.stopCheckingTarget();if(json.request===false){MeoReader.box.reset();MeoReader.loading.stop();MeoReader.box.create({id:"MeoReader_Import_Error",title:MeoReader.i18n.get("Error"),body:json.message,width:400,top:100,button:{ok:{enable:false},cancel:{enable:false},close:{enable:true}},state:"error"});jQuery("#MeoReader_Reader_Error h3").removeClass("loading");return;}MeoReader.Import.data=json.data;MeoReader.Import.doImport();}else{MeoReader.Import.targetCounter+=1;}}};MeoReader.Import.reset=function(){MeoReader.Import.feedCounter=0;MeoReader.Import.stack=[];MeoReader.Import.buggyFeeds=[];MeoReader.Import.currentCatID=0;MeoReader.Import.catIndex=0;MeoReader.Import.feedIndex=0;MeoReader.Import.timeout=5;MeoReader.Import.total.feeds=0;MeoReader.Import.total.cats=0;MeoReader.Import.data={};MeoReader.Import.active=false;MeoReader.Import.target=jQuery("#importFrame");MeoReader.Import.target.attr("src","admin.php?page=meoreader_blank");MeoReader.Import.timerRunning=undefined;};MeoReader.Import.startImport=function(){var bodyContent="<p>"+MeoReader.i18n.get("Depending on how many feeds you have, this might take a while")+".</p>";bodyContent+='<div id="MeoReader_UpdateFeed_Progress"><div class="stack">';bodyContent+=MeoReader.i18n.get("Progress")+": ";bodyContent+='<span class="current">0</span> '+MeoReader.i18n.get("of");bodyContent+=' <span class="total">0</span>';bodyContent+='</div><div class="feedName">&nbsp;</div></div>';MeoReader.Import.reset();MeoReader.Import.active=true;MeoReader.box.create({id:"MeoReader_Reader_ImportProgress",title:MeoReader.i18n.get("Importing Data"),body:bodyContent,width:400,top:100,button:{ok:{enable:false},cancel:{enable:false},close:{enable:true,label:MeoReader.i18n.get("Abort")}},state:"neutral"});jQuery("#MeoReader_Reader_ImportProgress h3").addClass("loading");MeoReader.Import.timerID=setInterval(MeoReader.Import.checkTarget,1000);MeoReader.Import.timerRunning=true;MeoReader.Import.checkTarget();};MeoReader.Import.quit=function(){var i=0,html="";MeoReader.Import.catIndex=0;MeoReader.Import.feedIndex=0;if(MeoReader.Import.buggyFeeds.length>0){html+="<p>"+MeoReader.i18n.get("The following feed(s) could not be added")+":</p>";html+="<ul>";for(i=0;i<MeoReader.Import.buggyFeeds.length;i++){html+="<li>"+MeoReader.Import.buggyFeeds[i]+"</li>";}html+="</ul>";MeoReader.box.title.removeClass("loading");MeoReader.box.footer.children(".btn.close").html(MeoReader.i18n.get("Close"));MeoReader.box.setBody(html);html="";}else{MeoReader.Import.reset();MeoReader.box.hide();MeoReader.box.reset();}MeoReader.updateSubscriptionList();};MeoReader.Import.addCategory=function(){if(MeoReader.Import.catIndex===(MeoReader.Import.data.length)||MeoReader.Import.active===false){MeoReader.Import.quit();return false;}jQuery.post(ajaxurl,{action:"meoReader",method:"addCategory",catName:MeoReader.Import.data[MeoReader.Import.catIndex].name,meoNonce:MeoReader.nonce.get("meoReader_addCategory")},function(response){var data=jQuery.parseJSON(response);if(data.request===true){MeoReader.Import.currentCatID=data.catID;MeoReader.Import.addFeed();}});};MeoReader.Import.addFeed=function(){if(MeoReader.Import.active===false){MeoReader.Import.quit();return;}if(MeoReader.Import.feedIndex===(MeoReader.Import.data[MeoReader.Import.catIndex].feeds.length)){MeoReader.Import.catIndex+=1;MeoReader.Import.feedIndex=0;MeoReader.Import.addCategory();return;}jQuery.post(ajaxurl,{action:"meoReader",method:"addFeed",catID:MeoReader.Import.currentCatID,feedURL:MeoReader.Import.data[MeoReader.Import.catIndex].feeds[MeoReader.Import.feedIndex],trueIfExists:"true",meoNonce:MeoReader.nonce.get("meoReader_addFeed")},function(response){var data=jQuery.parseJSON(response);if(data.request===false){MeoReader.Import.buggyFeeds.push('<a href="'+MeoReader.Import.data[MeoReader.Import.catIndex].feeds[MeoReader.Import.feedIndex]+'" title="'+data.message+'">'+MeoReader.Import.data[MeoReader.Import.catIndex].feeds[MeoReader.Import.feedIndex]+"</a>");}if(undefined!==MeoReader.Import.data[MeoReader.Import.catIndex].archive){MeoReader.Import.addArchiveEntries(MeoReader.Import.data[MeoReader.Import.catIndex].archive);}MeoReader.Import.feedCounter+=1;MeoReader.Import.feedIndex+=1;jQuery("#MeoReader_UpdateFeed_Progress .current").html((MeoReader.Import.feedCounter));MeoReader.Import.addFeed();});};MeoReader.Import.addArchiveEntries=function(entries){if(MeoReader.Import.active===false){MeoReader.Import.quit();return;}jQuery.post(ajaxurl,{action:"meoReader",method:"addArchiveEntries",catID:MeoReader.Import.currentCatID,feedURL:MeoReader.Import.data[MeoReader.Import.catIndex].feeds[MeoReader.Import.feedIndex],entries:entries,trueIfExists:"true"},function(response){return true;});};MeoReader.Import.doImport=function(){var i=0;for(i=0;i<MeoReader.Import.data.length;i++){MeoReader.Import.total.feeds+=MeoReader.Import.data[i].feeds.length;}jQuery("#MeoReader_UpdateFeed_Progress .total").html(MeoReader.Import.total.feeds);MeoReader.Import.addCategory();};jQuery("form.meoReader_import").submit(function(){var selectedFile=jQuery(this).children("div").children('input[type="file"]').val(),state=true;if(undefined!==selectedFile&&selectedFile.length>5){MeoReader.Import.startImport();}else{state=false;}return state;});if(MeoReader.compareVersions(MeoReader.jQueryVersion,"1.7.0")===-1){jQuery(document).on("click","#MeoReader_Reader_ImportProgress .btn_close, #MeoReader_Reader_ImportProgress .btn.close, #MeoReader_Reader_ImportProgress .btn.cancel",function(){MeoReader.Import.active=false;});}else{jQuery(document).delegate("#MeoReader_Reader_ImportProgress .btn_close, #MeoReader_Reader_ImportProgress .btn.close, #MeoReader_Reader_ImportProgress .btn.cancel","click",function(){MeoReader.Import.active=false;});}if(MeoReader.compareVersions(MeoReader.jQueryVersion,"1.7.0")===-1){jQuery(document).on("click","#MeoReader_Import_Error .btn_close, #MeoReader_Import_Error .btn.close",function(){MeoReader.box.reset();MeoReader.Import.reset();});}else{jQuery(document).delegate("#MeoReader_Import_Error .btn_close, #MeoReader_Import_Error .btn.close","click",function(){MeoReader.box.reset();MeoReader.Import.reset();});}
